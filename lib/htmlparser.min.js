"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function s(e,t){for(var a=0;a<t.length;a++){var s=t[a];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,a){return t&&s(e.prototype,t),a&&s(e,a),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function inherits(e,t){var a=function(){};a.prototype=t.prototype,e.super_=t,e.prototype=new a,e.prototype.constructor=e}!function(){var e;if("undefined"!=typeof module&&void 0!==module.exports)e=module.exports;else{if(e={},this.Tautologistics||(this.Tautologistics={}),this.Tautologistics.NodeHtmlParser)return;this.Tautologistics.NodeHtmlParser=e}}();var Mode={Text:"text",Script:"script",Tag:"tag",Attr:"attr",CData:"cdata",Doctype:"doctype",Comment:"comment"},TagType=[{langName:"mustache",open:"{{",close:"}}",openCode:"￰",closeCode:"￱"},{langName:"singleMustache",open:"{",close:"}",openCode:"￲",closeCode:"￳"}],opentags=[];function RssBuilder(e){RssBuilder.super_.call(this,e,{ignoreWhitespace:!0,verbose:!1,enforceEmptyTags:!1,caseSensitiveTags:!0})}TagType.forEach(function(e){opentags.push(e.openCode)},void 0),RssBuilder.prototype.done=function(){var e,i={},t=DomUtils.getElementsByTagName(function(e){return"rss"==e||"feed"==e},this.dom,!1);if(t.length&&(e=t[0]),e){if("rss"==e.name){i.type="rss",e=e.children[0],i.id="";try{i.title=DomUtils.getElementsByTagName("title",e.children,!1)[0].children[0].data}catch(e){}try{i.link=DomUtils.getElementsByTagName("link",e.children,!1)[0].children[0].data}catch(e){}try{i.description=DomUtils.getElementsByTagName("description",e.children,!1)[0].children[0].data}catch(e){}try{i.updated=new Date(DomUtils.getElementsByTagName("lastBuildDate",e.children,!1)[0].children[0].data)}catch(e){}try{i.author=DomUtils.getElementsByTagName("managingEditor",e.children,!1)[0].children[0].data}catch(e){}i.items=[],DomUtils.getElementsByTagName("item",e.children).forEach(function(e,t,a){var s={};try{s.id=DomUtils.getElementsByTagName("guid",e.children,!1)[0].children[0].data}catch(e){}try{s.title=DomUtils.getElementsByTagName("title",e.children,!1)[0].children[0].data}catch(e){}try{s.link=DomUtils.getElementsByTagName("link",e.children,!1)[0].children[0].data}catch(e){}try{s.description=DomUtils.getElementsByTagName("description",e.children,!1)[0].children[0].data}catch(e){}try{s.pubDate=new Date(DomUtils.getElementsByTagName("pubDate",e.children,!1)[0].children[0].data)}catch(e){}i.items.push(s)})}else{i.type="atom";try{i.id=DomUtils.getElementsByTagName("id",e.children,!1)[0].children[0].data}catch(e){}try{i.title=DomUtils.getElementsByTagName("title",e.children,!1)[0].children[0].data}catch(e){}try{i.link=DomUtils.getElementsByTagName("link",e.children,!1)[0].attributes.href.value}catch(e){}try{i.description=DomUtils.getElementsByTagName("subtitle",e.children,!1)[0].children[0].data}catch(e){}try{i.updated=new Date(DomUtils.getElementsByTagName("updated",e.children,!1)[0].children[0].data)}catch(e){}try{i.author=DomUtils.getElementsByTagName("email",e.children,!0)[0].children[0].data}catch(e){}i.items=[],DomUtils.getElementsByTagName("entry",e.children).forEach(function(e,t,a){var s={};try{s.id=DomUtils.getElementsByTagName("id",e.children,!1)[0].children[0].data}catch(e){}try{s.title=DomUtils.getElementsByTagName("title",e.children,!1)[0].children[0].data}catch(e){}try{s.link=DomUtils.getElementsByTagName("link",e.children,!1)[0].attributes.href.value}catch(e){}try{s.description=DomUtils.getElementsByTagName("summary",e.children,!1)[0].children[0].data}catch(e){}try{s.pubDate=new Date(DomUtils.getElementsByTagName("updated",e.children,!1)[0].children[0].data)}catch(e){}i.items.push(s)})}this.dom=i}RssBuilder.super_.prototype.done.call(this)};var DomUtils={testAttribute:function(e,t){for(var a=0;a<t.length;a++)if(e(t[a].data))return!0;return!1},testElement:function(e,t){if(!t)return!1;for(var a in e)if(e.hasOwnProperty(a))if("tag_name"==a){if(t.type!==Mode.Tag)return!1;if(!e.tag_name(t.name))return!1}else if("tag_type"==a){if(!e.tag_type(t.type))return!1}else if("tag_contains"==a){if(t.type!==Mode.Text&&t.type!==Mode.Comment&&t.type!==Mode.CData)return!1;if(!e.tag_contains(t.data))return!1}else if(!t.attributes||!t.attributes[a]||!DomUtils.testAttribute(e[a],t.attributes[a]))return!1;return!0},getElements:function(e,t,a,s){setPrototypeOfDomUtils=function(e){},a=null==a||!!a,s=isNaN(parseInt(s))?-1:parseInt(s);var i,n=[];if(setPrototypeOfDomUtils(n),!t)return n;function r(t){return function(e){return e==t}}for(var o in e)"function"!=typeof e[o]&&(e[o]=r(e[o]));if(DomUtils.testElement(e,t)&&n.push(t),0<=s&&n.length>=s)return n;if(a&&t.children)i=t.children;else{if(!(t instanceof Array))return n;i=t}for(var l=0;l<i.length&&(n=n.concat(DomUtils.getElements(e,i[l],a,s)),!(0<=s&&n.length>=s));l++);return n},getElementById:function(e,t,a){var s=DomUtils.getElements({id:e},t,a,1);return s.length?s[0]:null},getElementsByTagName:function(e,t,a,s){return DomUtils.getElements({tag_name:e},t,a,s)},getElementsByTagType:function(e,t,a,s){return DomUtils.getElements({tag_type:e},t,a,s)},removeChild:function(e,t){for(var a=0;a<t.children.length;a++)e===t.children[a]&&t.children.splice(a,1)},removeChildAll:function(e){e.children=[]}};function parseDOM(e,t){var a=new HtmlBuilder(t);new Parser(a,t).parseComplete(e);var s=new Element("#document",e);return s.parentNode={},s.children=a.dom||[],s}var Parser=exports.Parser=function(){function h(e,t){_classCallCheck(this,h),this.writable=!0,this._options=t||{},this._validateBuilder=function(e){if("object"!=(void 0===e?"undefined":_typeof(e)))throw new Error("Builder is not an object");if("function"!=typeof e.reset)throw new Error("Builder method 'reset' is invalid");if("function"!=typeof e.done)throw new Error("Builder method 'done' is invalid");if("function"!=typeof e.write)throw new Error("Builder method 'write' is invalid");if("function"!=typeof e.error)throw new Error("Builder method 'error' is invalid")},this._validateBuilder(e);this._builder=e,this.reset=function(){this._state={mode:Mode.Text,lastMode:Mode.Text,pos:0,data:null,pendingText:null,pendingWrite:null,lastTag:null,isScript:!1,needData:!1,output:[],done:!1,commentTagType:">",scriptTagType:null},this._builder.reset()},this.reset();var a=new ParseText(this);this._parseText=function(e){return a._parseText(e)};var s=new ParseScript(this);this._parseScript=function(e){return s._parseScript(e)};var i=new ParseTag(this);this._parseTag=function(e){return i._parseTag(e)};var n=new ParseAttr(this);this._parseAttr=function(e){return n._parseAttr(e)};var r=new ParseCData(this);this._parseCData=function(e){return r._parseCData(e)};var o=new ParseDoctype(this);this._parseDoctype=function(e){return o._parseDoctype(e)};var l=new ParseComment(this);this._parseComment=function(e){return l._parseComment(e)}}return _createClass(h,[{key:"write",value:function(e){e instanceof Buffer&&(e=e.toString()),this.parseChunk(e)}},{key:"end",value:function(e){arguments.length&&this.write(e),this.writable=!1,this.done()}},{key:"destroy",value:function(){this.writable=!1}},{key:"parseChunk",value:function(e){for(this._state.needData=!1,this._state.data=null!==this._state.data?this._state.data.substr(this.pos)+e:e;this._state.pos<this._state.data.length&&!this._state.needData;)this._parse(this._state)}},{key:"parseComplete",value:function(t){t&&(this.reset(),TagType.forEach(function(e){t=t.replace(new RegExp(e.open,"g"),e.openCode).replace(new RegExp(e.close,"g"),e.closeCode)},this),this.parseChunk(t),this.done())}},{key:"done",value:function(){this._state.done=!0,this._parse(this._state),this._flushWrite(),this._builder.done()}},{key:"_parse",value:function(){switch(this._state.mode){case Mode.Text:return this._parseText(this._state);case Mode.Script:return this._parseScript(this._state);case Mode.Tag:return this._parseTag(this._state);case Mode.Attr:return this._parseAttr(this._state);case Mode.CData:return this._parseCData(this._state);case Mode.Doctype:return this._parseDoctype(this._state);case Mode.Comment:return this._parseComment(this._state)}}},{key:"_writePending",value:function(e){this._state.pendingWrite||(this._state.pendingWrite=[]),this._state.pendingWrite.push(e)}},{key:"_flushWrite",value:function(){if(this._state.pendingWrite){for(var e=0,t=this._state.pendingWrite.length;e<t;e++){var a=this._state.pendingWrite[e];this._builder.write(a)}this._state.pendingWrite=null}}},{key:"_write",value:function(e){this._flushWrite(),this._builder.write(e)}}]),h}(),ParseText=exports.ParseText=function(){function t(e){_classCallCheck(this,t),this.perser=e,this._re_parseText_tagOpen=new RegExp("([\\<"+opentags.join("")+"])","g"),this._re_parseText_scriptClose=/<\s*\/\s*(x\-)?script/gi}return _createClass(t,[{key:"_parseText",value:function(t){var a,s=Mode.Tag;if(t.isScript)this._re_parseText_scriptClose.lastIndex=t.pos,a=(a=this._re_parseText_scriptClose.exec(t.data))?a.index:-1;else{this._re_parseText_tagOpen.lastIndex=t.pos;var i=this._re_parseText_tagOpen.exec(t.data);i?"<"==i[0]?(s=Mode.Tag,a=i.index):TagType.forEach(function(e){i[0]==e.openCode&&(s=Mode.Script,t.lastMode=Mode.Text,a=i.index,t.scriptTagType=e)},this.perser):(s=Mode.Tag,a=-1)}var e=-1===a?t.data.substring(t.pos,t.data.length):t.data.substring(t.pos,a);if(a<0&&t.done&&(a=t.data.length),a<0){if(t.isScript)return void(t.needData=!0);t.pendingText||(t.pendingText=[]),t.pendingText.push(t.data.substring(t.pos,t.data.length)),t.pos=t.data.length}else t.pendingText?(t.pendingText.push(t.data.substring(t.pos,a)),e=t.pendingText.join(""),t.pendingText=null):e=t.data.substring(t.pos,a),""!==e&&this.perser._write({type:Mode.Text,data:e}),t.pos=a+1,t.mode=s}}]),t}(),ParseScript=exports.ParseScript=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseScript=/\s*([\/\#][^\s\}]+)?(\!\-*)?\s*([^\}]*?)\}/g}return _createClass(t,[{key:"_parseScript",value:function(e){var t="\\s*([\\/\\#][^\\s"+e.scriptTagType.closeCode+"]+)?(\\!\\-*)?\\s*([^"+e.scriptTagType.closeCode+"]*?)"+e.scriptTagType.closeCode;this.re_parseScript=new RegExp(t,"g"),this.re_parseScript.lastIndex=e.pos;var a=this.re_parseScript.exec(e.data);if(a){if(e.mode=Mode.Script,a[2]&&"!--"===a[2].substr(0,3))return e.mode=Mode.Comment,e.commentTagType=e.scriptTagType.closeCode,void(e.pos+=3);a[2]&&"!"==a[2].charAt(0)&&(e.mode=Mode.Comment,e.commentTagType=e.scriptTagType.closeCode,e.pos+=1);var s=a[3];e.pendingText&&(e.pendingText.push(s),s=e.pendingText.join(""),e.pendingText=null),""!==s&&this.perser._write({type:e.mode,name:a[1]||a[2],data:s,langName:e.scriptTagType.langName}),e.pos+=a[0].length,e.mode=e.lastMode}else e.needData=!0}}]),t}(),ParseTag=exports.ParseTag=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseTag=/\s*(\/?)\s*([^\s>\/]+)(\s*)\??(>?)/g}return _createClass(t,[{key:"_parseTag",value:function(e){this.re_parseTag.lastIndex=e.pos;var t=this.re_parseTag.exec(e.data);if(t){if(!t[1]&&"!--"===t[2].substr(0,3))return e.mode=Mode.Comment,e.commentTagType=">",void(e.pos+=3);if(!t[1]&&"![CDATA["===t[2].substr(0,8))return e.mode=Mode.CData,void(e.pos+=8);if(!t[1]&&"!DOCTYPE"===t[2].substr(0,8))return e.mode=Mode.Doctype,void(e.pos+=8);if(!e.done&&e.pos+t[0].length===e.data.length)return void(e.needData=!0);var a;a=">"===t[4]?(e.mode=Mode.Text,t[0].substr(0,t[0].length-1)):(e.mode=Mode.Attr,t[0]),e.pos+=t[0].length;var s={type:Mode.Tag,name:t[1]+t[2],raw:a};e.mode===Mode.Attr&&(e.lastTag=s),"script"===s.name.toLowerCase()?e.isScript=!0:"/script"===s.name.toLowerCase()&&(e.isScript=!1),"x-script"===s.name.toLowerCase()?e.isScript=!0:"/x-script"===s.name.toLowerCase()&&(e.isScript=!1),e.mode===Mode.Attr?this.perser._writePending(s):this.perser._write(s)}else e.needData=!0}}]),t}(),ParseAttr_findName=exports.ParseAttr_findName=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseAttr_findName=/\s*([^=<>\s'"\/]+)\s*/g}return _createClass(t,[{key:"_parseAttr_findName",value:function(e){this.re_parseAttr_findName.lastIndex=e.pos;var t=this.re_parseAttr_findName.exec(e.data);return t?e.pos+t[0].length!==this.re_parseAttr_findName.lastIndex?null:{match:t[0],name:t[1]}:null}}]),t}(),ParseAttr_findValue=exports.ParseAttr_findValue=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseAttr_findValue=/\s*=\s*(?:'([^']*)'|"([^"]*)"|([^'"\s\/>]+))\s*/g,this.re_parseAttr_findValue_last=/\s*=\s*['"]?(.*)$/g}return _createClass(t,[{key:"_parseAttr_findValue",value:function(e){this.re_parseAttr_findValue.lastIndex=e.pos;var t=this.re_parseAttr_findValue.exec(e.data);return t?e.pos+t[0].length!==this.re_parseAttr_findValue.lastIndex?null:{match:t[0],value:t[1]||t[2]||t[3]}:e.done?(this.re_parseAttr_findValue_last.lastIndex=e.pos,(t=this.re_parseAttr_findValue_last.exec(e.data))?{match:t[0],value:""!==t[1]?t[1]:null}:null):null}}]),t}(),ParseAttr=exports.ParseAttr=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseAttr_splitValue=/^\s*=\s*['"]?/g,this.re_parseAttr_selfClose=/(\s*\/\s*)(>?)/g,this.parseAttr_findName=new ParseAttr_findName(e),this.parseAttr_findValue=new ParseAttr_findValue(e)}return _createClass(t,[{key:"_parseAttr",value:function(e){var t=this.parseAttr_findName._parseAttr_findName(e);if(t&&"?"!==t.name){if(!e.done&&e.pos+t.match.length===e.data.length)return e.needData=!0,null;e.pos+=t.match.length;var a=this.parseAttr_findValue._parseAttr_findValue(e);if(a){if(!e.done&&e.pos+a.match.length===e.data.length)return e.needData=!0,void(e.pos-=t.match.length);e.pos+=a.match.length}else{if(this.re_parseAttr_splitValue.lastIndex=e.pos,this.re_parseAttr_splitValue.exec(e.data))return e.needData=!0,void(e.pos-=t.match.length);a={match:"",value:null}}e.lastTag.raw+=t.match+a.match;var s=[];if(a.value){var i=new HtmlBuilder(function(e,t){},this.perser._builder._options);new Parser(i).parseComplete(a.value),s=i.dom}this.perser._writePending({type:Mode.Attr,name:t.name,data:s})}else{this.re_parseAttr_selfClose.lastIndex=e.pos;var n=this.re_parseAttr_selfClose.exec(e.data);if(n&&n.index===e.pos){if(!e.done&&!n[2]&&e.pos+n[0].length===e.data.length)return void(e.needData=!0);e.lastTag.raw+=n[1],this.perser._write({type:Mode.Tag,name:"/"+e.lastTag.name,raw:null}),e.pos+=n[1].length}var r=e.data.indexOf(">",e.pos);if(r<0){if(e.done)return e.lastTag.raw+=e.data.substr(e.pos),void(e.pos=e.data.length);e.needData=!0}else e.pos=r+1,e.mode=Mode.Text}}}]),t}(),ParseCData=exports.ParseCData=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseCData_findEnding=/\]{1,2}$/}return _createClass(t,[{key:"_parseCData",value:function(e){var t=e.data.indexOf("]]>",e.pos);if(t<0&&e.done&&(t=e.data.length),t<0){if(this.re_parseCData_findEnding.lastIndex=e.pos,this.re_parseCData_findEnding.exec(e.data))return void(e.needData=!0);e.pendingText||(e.pendingText=[]),e.pendingText.push(e.data.substr(e.pos,e.data.length)),e.pos=e.data.length,e.needData=!0}else{var a;e.pendingText?(e.pendingText.push(e.data.substring(e.pos,t)),a=e.pendingText.join(""),e.pendingText=null):a=e.data.substring(e.pos,t),this.perser._write({type:Mode.CData,data:a}),e.mode=Mode.Text,e.pos=t+3}}}]),t}(),ParseDoctype=exports.ParseDoctype=function(){function t(e){_classCallCheck(this,t),this.perser=e}return _createClass(t,[{key:"_parseDoctype",value:function(e){var t,a=e.data.indexOf(">",e.pos);(a<0&&e.done&&(a=e.data.length),a<0)?(this.re_parseCData_findEnding.lastIndex=e.pos,e.pendingText||(e.pendingText=[]),e.pendingText.push(e.data.substr(e.pos,e.data.length)),e.pos=e.data.length,e.needData=!0):(e.pendingText?(e.pendingText.push(e.data.substring(e.pos,a)),t=e.pendingText.join(""),e.pendingText=null):t=e.data.substring(e.pos,a),this.perser._write({type:Mode.Doctype,data:t}),e.mode=Mode.Text,e.pos=a+1)}}]),t}(),ParseComment=exports.ParseComment=function(){function t(e){_classCallCheck(this,t),this.perser=e,this.re_parseComment_findEnding=/\-{1,2}$/}return _createClass(t,[{key:"_parseComment",value:function(e){var t=e.data.indexOf("--"+e.commentTagType,e.pos);if(t<0&&e.done&&(t=e.data.length),t<0){if(this.re_parseComment_findEnding.lastIndex=e.pos,this.re_parseComment_findEnding.exec(e.data))return void(e.needData=!0);e.pendingText||(e.pendingText=[]),e.pendingText.push(e.data.substr(e.pos,e.data.length)),e.pos=e.data.length,e.needData=!0}else{var a;e.pendingText?(e.pendingText.push(e.data.substring(e.pos,t)),a=e.pendingText.join(""),e.pendingText=null):a=e.data.substring(e.pos,t),this.perser._write({type:Mode.Comment,data:a}),e.mode=Mode.Text,e.pos=t+3}}}]),t}(),HtmlBuilder=function(){function a(e,t){_classCallCheck(this,a),this._options=null,this._callback=null,this._done=!1,this._tagStack=null,this.dom=null,this._emptyTags={area:1,base:1,basefont:1,br:1,col:1,frame:1,hr:1,img:1,input:1,isindex:1,link:1,meta:1,param:1,embed:1,"?xml":1,wbr:1},this.reWhitespace=/^\s*$/,this.reset(),"function"==typeof e?this._callback=e:t=e,this._options=t||{},void 0===this._options.ignoreWhitespace&&(this._options.ignoreWhitespace=!1),void 0===this._options.includeLocation&&(this._options.includeLocation=!1),void 0===this._options.verbose&&(this._options.verbose=!0),void 0===this._options.enforceEmptyTags&&(this._options.enforceEmptyTags=!0),void 0===this._options.caseSensitiveTags&&(this._options.caseSensitiveTags=!1),void 0===this._options.caseSensitiveAttr&&(this._options.caseSensitiveAttr=!1)}return _createClass(a,[{key:"setPrototypeOfDomUtils",value:function(e){}},{key:"reset",value:function(){this.dom=[],this.setPrototypeOfDomUtils(this.dom),this._done=!1,this._tagStack=[],this._lastTag=null,this._tagStack.last=function(){return this.length?this[this.length-1]:null},this._line=1,this._col=1}},{key:"done",value:function(){this._done=!0,this.handleCallback(null)}},{key:"error",value:function(e){this.handleCallback(e)}},{key:"handleCallback",value:function(e){if("function"==typeof this._callback)this._callback(e,this.dom);else if(e)throw e}},{key:"isEmptyTag",value:function(e){var t=e.name.toLowerCase();return"?"==t.charAt(0)||("/"==t.charAt(0)&&(t=t.substring(1)),this._options.enforceEmptyTags&&!!this._emptyTags[t])}},{key:"_getLocation",value:function(){return{line:this._line,col:this._col}}},{key:"_updateLocation",value:function(e){var t=e.type===Mode.Tag?e.raw:e.data;if(null!==t){var a=t.split("\n");this._line+=a.length-1,1<a.length&&(this._col=1),this._col+=a[a.length-1].length,e.type===Mode.Tag?this._col+=2:e.type===Mode.Comment?this._col+=7:e.type===Mode.CData&&(this._col+=12)}}},{key:"_copyElement",value:function(t,e){var a=new Element(t.type,e);if(this._options.verbose&&void 0!==t.raw&&(a.raw=t.raw),void 0!==t.name)switch(t.type){case Mode.Tag:a.name=this._options.caseSensitiveTags?t.name:t.name.toLowerCase();break;case Mode.Attr:a.name=this._options.caseSensitiveAttr?t.name:t.name.toLowerCase();break;default:a.name=this._options.caseSensitiveTags?t.name:t.name.toLowerCase()}return void 0!==t.data&&(TagType.forEach(function(e){t.data=t.data.replace(new RegExp(e.openCode,"g"),e.open).replace(new RegExp(e.closeCode,"g"),e.close)},this),a.data=t.data),void 0!==t.langName&&(a.langName=t.langName),t.location&&(a.location={line:t.location.line,col:t.location.col}),a}},{key:"write",value:function(e){var t,a;if(this._done&&this.handleCallback(new Error("Writing to the builder after done() called is not allowed without a reset()")),this._options.includeLocation&&e.type!==Mode.Attr&&(e.location=this._getLocation(),this._updateLocation(e)),e.type!==Mode.Text||!this._options.ignoreWhitespace||!this.reWhitespace.test(e.data))if(this._tagStack.last())if(e.type===Mode.Tag)if("/"==e.name.charAt(0)){var s=this._options.caseSensitiveTags?e.name.substring(1):e.name.substring(1).toLowerCase();if(!this.isEmptyTag(e)){for(var i=this._tagStack.length-1;-1<i&&this._tagStack[i--].name!=s;);if(-1<i||this._tagStack[0].name==s)for(;i<this._tagStack.length-1;)this._tagStack.pop()}}else t=this._tagStack.last(),e.type===Mode.Attr?(t.attributes||(t.attributes={}),t.attributes[this._options.caseSensitiveAttr?e.name:e.name.toLowerCase()]=e.data):(a=this._copyElement(e,t),t.children||(t.children=[]),t.children.push(a),this.isEmptyTag(a)||this._tagStack.push(a),e.type===Mode.Tag&&(this._lastTag=a));else if(e.type===Mode.Script)if(e.name&&"/"==e.name.charAt(0)){s=this._options.caseSensitiveTags?e.name.substring(1):e.name.substring(1).toLowerCase();if(!this.isEmptyTag(e)){for(i=this._tagStack.length-1;-1<i&&this._tagStack[i--].name!=s;);if(-1<i||this._tagStack[0].name==s)for(;i<this._tagStack.length-1;)this._tagStack.pop()}}else e.name&&"!"==e.name.charAt(0)?(t=this._tagStack.last(),e.name&&(e.name=this._options.caseSensitiveTags?e.name.substring(1):e.name.substring(1).toLowerCase()),a=this._copyElement(e,t),t.children||(t.children=[]),t.children.push(a)):(t=this._tagStack.last(),e.name&&(e.name=this._options.caseSensitiveTags?e.name.substring(1):e.name.substring(1).toLowerCase()),a=this._copyElement(e,t),t.children||(t.children=[]),t.children.push(a),e.name&&this._tagStack.push(a)),this._lastTag=a;else t=this._tagStack.last(),e.type===Mode.Attr?(this._lastTag.attributes||(this._lastTag.attributes={}),this._lastTag.attributes[this._options.caseSensitiveAttr?e.name:e.name.toLowerCase()]=e.data):(t.children||(t.children=[]),t.children.push(this._copyElement(e,t)));else if(e.type===Mode.Tag)"/"!=e.name.charAt(0)&&(a=this._copyElement(e),this.dom.push(a),this.isEmptyTag(a)||this._tagStack.push(a),this._lastTag=a);else if(e.type===Mode.Attr&&this._lastTag)this._lastTag.attributes||(this._lastTag.attributes={}),this._lastTag.attributes[this._options.caseSensitiveAttr?e.name:e.name.toLowerCase()]=e.data;else if(e.type===Mode.Script){if(e.name&&"/"==e.name.charAt(0))return;e.name&&"!"==e.name.charAt(0)?(e.name=this._options.caseSensitiveTags?e.name.substring(1):e.name.substring(1).toLowerCase(),a=this._copyElement(e),this.dom.push(a)):e.name?(e.name&&(e.name=this._options.caseSensitiveTags?e.name.substring(1):e.name.substring(1).toLowerCase()),a=this._copyElement(e),this.dom.push(a),this._tagStack.push(a)):(a=this._copyElement(e),this.dom.push(a)),this._lastTag=a}else this.dom.push(this._copyElement(e))}}]),a}();exports.HtmlBuilder=HtmlBuilder,exports.DefaultHandler=HtmlBuilder;var Element=exports.Element=function(){function s(e,t){_classCallCheck(this,s),this.type=e,this.parentNode=t}return _createClass(s,[{key:"getElementById",value:function(e,t){return DomUtils.getElementById(e,this,t)}},{key:"getElementsByTagName",value:function(e,t,a){return DomUtils.getElementsByTagName(e,this,t,a)}},{key:"getElementsByTagType",value:function(e,t,a){return DomUtils.getElementsByTagType(e,this,t,a)}},{key:"getElements",value:function(e,t,a){return DomUtils.getElements(e,this,t,a)}},{key:"removeChildAll",value:function(){return DomUtils.removeChildAll(this)}},{key:"removeChild",value:function(e){return DomUtils.removeChild(e,this)}},{key:"createNode",value:function(e,t){return new s(e,t||null)}},{key:"createElement",value:function(e,t){var a=new s("tag",t||null);return a.name=e,a}},{key:"createTextNode",value:function(e,t){var a=new s("text",t||null);return a.data=e,a}},{key:"appendChild",value:function(e){this.children=this.children||[],(e.parentNode=this).children.push(e)}},{key:"insertBefore",value:function(e,t){this.children=this.children||[];var a=this.children.indexOf(t);this.children.splice(a,0,e)}},{key:"getAttribute",value:function(e){this.attributes[e]}},{key:"cloneElement",value:function(e){var t=this.createNode(this.type,e||{});if(this.name&&(t.name=this.name),this.raw&&(t.raw=this.raw),this.location&&(t.location={line:this.location.line,col:this.location.col}),this.langName&&(t.langName=this.langName),this.data&&(t.data=this.data),this.attributes&&(t.attributes=function(e){var t={};for(var a in e){for(var s=e[a],i=[],n=0;n<s.length;n++){var r=s[n],o={type:r.type,data:r.data};r.langName&&(o.langName=r.langName),i.push(o)}t[a]=i}return t}(this.attributes)),this.children){t.children=[];for(var a=0;a<this.children.length;a++){this.children[a].cloneElement(t)}}return t.parentNode.children?t.parentNode.children.push(t):t.parentNode.children=[t],t}},{key:"nextSibling",get:function(){if(!this.parentNode||!this.parentNode.children)return null;var e=this.parentNode.children.indexOf(this);return-1==e||this.parentNode.children.lenght<=e?null:this.parentNode.children[e+1]}},{key:"attribs",get:function(){if(!this.attributes)return null;var e={};for(var t in this.attributes){var a="";this.attributes[t].forEach(function(e){a=e.data||""}),e[t]=a}return console.log("attribs",e),e}}]),s}();